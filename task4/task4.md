# ADR-004: Передача ставок в кол-центр

# Автор: Команда цифровой трансформации

# Дата: 07 мая 2025

## Статус
Предложено

## Контекст
В рамках цифровой трансформации банка «Стандарт» требуется обеспечить доступ к актуальным ставкам по депозитам для внутреннего и партнёрского кол-центров. Клиенты, преимущественно пожилые, уточняют условия по телефону, что увеличит нагрузку на кол-центр после маркетинговой кампании. Внутренний кол-центр интегрирован с Deposit System через REST API и Kafka (задание 3, F3, F1.2). Партнёрский кол-центр работает во внешней системе, принимает данные только в виде файлов через SFTP (Secure File Transfer Protocol) и не поддерживает API. Решение интегрируется в MVP из задания 3, минимизируя изменения в АБС и Rates Service.

## Решение
- **Внутренний кол-центр**: Rates Service предоставляет ставки через REST API (как для Back-Office UI, F5.1, F5.2 в задании 3) через API Gateway. Система колл-центра запрашивает данные синхронно и отображает их сотрудникам.
- **Партнёрский кол-центр**: В базе данных Rates Service (MS SQL) на таблицу ставок навешаны триггеры, которые срабатывают после транзакций обновления или создания ставок. Триггер выполняет агрегацию данных (при необходимости из нескольких таблиц), формирует CSV-файл (поля: `deposit_id`, `rate`, `term`, `min_amount`) и загружает его на SFTP-сервер — защищённое файловое хранилище, доступное через SSH, а не почту. Партнёрская система скачивает CSV через SFTP, парсит его и отображает ставки. Передача включает до 3 повторных попыток при сбоях.
  Изменения локализуются в Rates Service и его базе данных, добавляя триггеры и SFTP-интеграцию.

# Функциональные требования

| **№** | **Действующие лица или системы** | **Use Case** | **Описание** | **Покрываемое требование** |
| :-: | :- | :- | :- | :- |
| 1 | Сотрудник внутреннего кол-центра, Система колл-центра, Rates Service | Просмотр актуальных ставок внутренним кол-центром | Сотрудник открывает интерфейс системы колл-центра, которая запрашивает актуальные ставки через REST API у Rates Service. Rates Service возвращает данные (JSON), и система отображает их в таблице. | F6.1 |
| 2 | Сотрудник партнёрского кол-центра, Внешняя система колл-центра | Просмотр актуальных ставок партнёрским кол-центром | Сотрудник открывает интерфейс внешней системы, которая отображает актуальные ставки, загруженные из CSV-файла, скачанного через SFTP. | F6.2 |
| 3 | Rates Service, Внешняя система колл-центра | Передача и обработка ставок для партнёрского кол-центра | Триггер в базе данных Rates Service (MS SQL) срабатывает после транзакции обновления/создания ставки, агрегирует данные (при необходимости из нескольких таблиц), формирует CSV-файл (ID, процент, срок, минимальная сумма) и загружает его на SFTP-сервер (до 3 попыток при сбоях). Внешняя система периодически скачивает CSV через SFTP, парсит его и обновляет ставки в своей базе данных или интерфейсе. | F6.2, F6.3 |

# Нефункциональные и архитектурно-значимые требования

| **№** | **Требование** | **Код FURPS+** | **Значимость** |
| :-: | :- | :- | :- |
| 1 | Время ответа REST API не превышает 500 мс для 95% запросов. | P6.1 | Быстрый доступ для внутреннего кол-центра. |
| 2 | Время формирования и загрузки CSV-файла триггером не превышает 5 минут. | P6.2 | Своевременный доступ для партнёрского кол-центра. |
| 3 | Данные ставок актуальны на момент запроса (API) или экспорта (CSV, задержка до 10 минут). | P6.3 | Гарантирует актуальность. |
| 4 | Передача CSV через SFTP защищена шифрованием и аутентификацией (SSH-ключи). [ASR] | +R6.1 | Обеспечивает безопасность. |
| 5 | Система поддерживает до 100 одновременных запросов к API. | P6.4 | Производительность при пиковой нагрузке. |
| 6 | CSV-файл совместим с внешними системами (UTF-8, поля: ID, процент, срок, минимальная сумма). | U6.1 | Читаемость в партнёрской системе. |
| 7 | Минимизация изменений в АБС и сервисах. [ASR] | +R6.2 | Локализация доработок в Rates Service и его БД. |
| 8 | Логирование операций API, триггеров и экспорта CSV, включая сбои SFTP. | R6.1 | Диагностика ошибок. |
| 9 | Повторные попытки (до 3) при сбоях передачи CSV через SFTP. | R6.2 | Надёжность доставки. |
| 10 | Триггеры не увеличивают время транзакций обновления/создания ставок более чем на 100 мс. | P6.5 | Минимизация влияния на производительность БД. |

# Решение

## Логика принятия решений
Решение использует MVP из задания 3, где Rates Service управляет ставками через АБС и предоставляет REST API (F5.1, F5.2). Внутренний кол-центр использует API, как в задании 3 (F3). Партнёрский кол-центр получает CSV через SFTP из-за отсутствия API. Триггеры в базе данных Rates Service обеспечивают реактивный экспорт CSV при изменениях ставок.
1. **REST API для внутреннего кол-центра**:
    - **Требования**: UC-001 (F6.1), P6.1, P6.4.
    - **Обоснование**: Использует существующую интеграцию (F3), минимизирует изменения (+R6.2).
2. **CSV и SFTP с триггерами для партнёрского кол-центра**:
    - **Требования**: UC-002, UC-003 (F6.2, F6.3), +R6.1, U6.1, P6.5.
    - **Обоснование**: Триггеры обеспечивают немедленный экспорт при изменениях, SFTP — защищённый протокол для передачи файлов, соответствующий ограничению партнёра, CSV — стандартный формат.
3. **Технологии (Spring Boot, MS SQL, OpenSSH)**:
    - **Требования**: S1, +R6.1.
    - **Обоснование**: Совместимость с текущим стеком, безопасность SFTP, триггеры в MS SQL.

## Формат CSV
CSV-файл имеет структуру:
```
deposit_id,rate,term,min_amount
1,5.5,12,10000
2,6.0,24,50000
```
- **Кодировка**: UTF-8.
- **Разделитель**: запятая.
- **Поля**: `deposit_id` (уникальный ID), `rate` (процент, десятичное), `term` (срок в месяцах), `min_amount` (минимальная сумма, целое).

## Процесс получения ставок партнёрским кол-центром
1. При обновлении/создании ставки в таблице Rates Service (MS SQL) срабатывает триггер.
2. Триггер агрегирует данные (при необходимости из нескольких таблиц), формирует CSV и вызывает хранимую процедуру для загрузки на SFTP-сервер (до 3 попыток при сбоях).
3. Внешняя система партнёрского кол-центра подключается к SFTP-серверу (по расписанию, например, каждый час), используя SSH-ключи, и скачивает CSV.
4. Система парсит CSV и обновляет ставки в своей базе данных или интерфейсе.
5. Сотрудники видят ставки в интерфейсе (таблица с полями ID, процент, срок, сумма).

## Диаграммы C4

### Диаграмма контекста
![Диаграмма](https://drive.google.com/uc?id=12powb6XjsULPGeeVT5iX54iyZSeDdUsG)
```plantuml
@startuml
!include https://raw.githubusercontent.com/vasilokb/plantUML/refs/heads/main/C4.puml

Person(call_center_employee, "Сотрудник внутреннего кол-центра", "Просматривает ставки")
Person(partner_call_center_employee, "Сотрудник партнёрского кол-центра", "Просматривает ставки")
Person(deposit_back_office, "Бэк-офис депозитов", "Управляет ставками")

System(call_center_system, "Система колл-центра", "Запрашивает ставки через API", "React.js, Java Spring Boot, PostgreSQL") #lightgreen
System(partner_call_center_system, "Внешняя система колл-центра", "Скачивает CSV через SFTP") #lightblue
System(deposit_system, "Deposit System", "Предоставляет ставки, экспортирует CSV", "Spring Boot, MS SQL") #lightgreen
System(abs, "АБС", "Хранит данные ставок", "Delphi, Oracle") #lightblue
System(sftp_server, "SFTP-сервер", "Хранит CSV") #lightgray

Rel(call_center_employee, call_center_system, "Просмотр ставок", "HTTPS")
Rel(partner_call_center_employee, partner_call_center_system, "Просмотр ставок", "HTTPS")
Rel(deposit_back_office, deposit_system, "Управление ставками", "REST API")
Rel(call_center_system, deposit_system, "Запрос ставок", "REST API")
Rel(deposit_system, sftp_server, "Экспорт CSV", "SFTP")
Rel(partner_call_center_system, sftp_server, "Скачивание CSV", "SFTP")
Rel(deposit_system, abs, "Запрос ставок", "REST API")

@enduml
```

**Описание**:
- **Сотрудник внутреннего кол-центра**: Просматривает ставки через систему колл-центра (F6.1).
- **Сотрудник партнёрского кол-центра**: Просматривает ставки через внешнюю систему (F6.2).
- **Бэк-офис депозитов**: Управляет ставками (F5.1).
- **Система колл-центра**: Запрашивает ставки через REST API.
- **Внешняя система колл-центра**: Скачивает CSV через SFTP.
- **Deposit System**: Предоставляет ставки через API, экспортирует CSV (триггеры).
- **АБС**: Хранит ставки.
- **SFTP-сервер**: Защищённое файловое хранилище для CSV.

### Диаграмма контейнеров
![Диаграмма](https://drive.google.com/uc?id=1X9Y-Ni8zOueUiAbML0udDe5E5uJQI6ru)
```plantuml
@startuml
!include https://raw.githubusercontent.com/vasilokb/plantUML/refs/heads/main/C4.puml

Person(call_center_employee, "Сотрудник внутреннего кол-центра", "Просматривает ставки")
Person(partner_call_center_employee, "Сотрудник партнёрского кол-центра", "Просматривает ставки")
Person(deposit_back_office, "Бэк-офис депозитов", "Управляет ставками")

Boundary(bank_system, "Банк - Системы") {
  Container(call_center_system, "Система колл-центра", "React.js, Java Spring Boot, PostgreSQL", "Запрашивает ставки через API") #lightgreen
  Container(back_office_ui, "Back-Office UI", "React, Spring Boot", "Интерфейс для управления ставками") #purple
  Boundary(deposit_microservices, "Deposit Microservices") {
    Container(rates_service, "Rates Service", "Spring Boot, MS SQL", "Предоставляет ставки, управляет триггерами для экспорта CSV") #lightgreen
  }
  Container(abs_adapter, "ABS Adapter", "Spring Boot, MS SQL", "Обёртка для АБС") #lightgray
  Container(abs, "АБС", "Delphi, Oracle", "Хранит данные ставок") #lightblue
  Container(api_gateway, "API Gateway", "Nginx, OAuth 2.0", "Маршрутизация, аутентификация") #lightgray
  Container(sftp_server, "SFTP-сервер", "OpenSSH", "Хранит CSV") #lightgray
}

System(partner_call_center_system, "Внешняя система колл-центра", "Скачивает CSV через SFTP") #lightblue

Rel(call_center_employee, call_center_system, "Просмотр ставок", "HTTPS")
Rel(partner_call_center_employee, partner_call_center_system, "Просмотр ставок", "HTTPS")
Rel(deposit_back_office, back_office_ui, "Управление ставками", "HTTPS")
Rel(back_office_ui, api_gateway, "Запросы к Rates Service", "REST API")
Rel(call_center_system, api_gateway, "Запрос ставок", "REST API")
Rel(api_gateway, rates_service, "Маршрутизация запросов", "REST API")
Rel(rates_service, sftp_server, "Экспорт CSV (триггеры)", "SFTP")
Rel(partner_call_center_system, sftp_server, "Скачивание CSV", "SFTP")
Rel(rates_service, abs_adapter, "Запрос ставок", "REST API")
Rel(abs_adapter, abs, "Запрос ставок", "REST API")

@enduml
```

**Описание компонентов**:
- **Система колл-центра**: Запрашивает ставки через REST API (F6.1).
- **Внешняя система колл-центра**: Скачивает и парсит CSV через SFTP (F6.2).
- **Back-Office UI**: Управляет ставками (F5.1).
- **Rates Service**: Предоставляет ставки через API, управляет триггерами для экспорта CSV.
- **ABS Adapter**: REST API для доступа к ставкам.
- **АБС**: Хранит ставки.
- **API Gateway**: Маршрутизирует запросы.
- **SFTP-сервер**: Защищённое файловое хранилище для CSV.

## Интеграции
- **Back-Office UI → Rates Service**: REST API через API Gateway (F5.1).
- **Система колл-центра → Rates Service**: REST API через API Gateway (F6.1).
- **Rates Service → SFTP-сервер**: Загрузка CSV триггерами, до 3 попыток (F6.2).
- **Внешняя система колл-центра → SFTP-сервер**: Скачивание CSV (F6.2).
- **Rates Service → АБС**: REST API через ABS Adapter (F6.3).
- **Безопасность**: HTTPS, OAuth 2.0 (API Gateway), SFTP с SSH-ключами.

## Альтернативы
1. **CSV для внутреннего кол-центра**:
    - **Описание**: Экспорт CSV в локальную файловую систему.
    - **Недостатки**: Отклонение от REST API (F3 в задании 3), лишняя сложность.
    - **Причина отказа**: Не использует существующую интеграцию.
2. **REST API для партнёрского кол-центра**:
    - **Описание**: Rates Service предоставляет API.
    - **Недостатки**: Партнёр не поддерживает API (ограничение задания).
    - **Причина отказа**: Несоответствие требованиям.
3. **Передача CSV по электронной почте**:
    - **Описание**: Rates Service отправляет CSV как вложение на email партнёрского кол-центра.
    - **Недостатки**: Менее безопасно (нет шифрования по умолчанию), сложнее автоматизировать скачивание, не соответствует указанию задания (SFTP).
    - **Причина отказа**: Не отвечает требованиям безопасности (+R6.1) и автоматизации.
4. **Асинхронный обработчик вместо триггеров**:
    - **Описание**: Изменения ставок записываются в очередь событий (Outbox или CDC), обработчик формирует CSV и загружает на SFTP.
    - **Недостатки**: Требует дополнительной инфраструктуры (очереди), сложнее для немедленного экспорта.
    - **Причина отказа**: Триггеры проще для быстрого внедрения в MVP, обеспечивают немедленную реакцию.
5. **Ручной экспорт CSV**:
    - **Описание**: Бэк-офис вручную экспортирует CSV.
    - **Недостатки**: Риск ошибок, задержки (P6.3).
    - **Причина отказа**: Не соответствует автоматизации (F6.3).

## Недостатки, ограничения, риски
- **Недостатки**:
    - CSV для партнёра ограничивает реальное время (задержка до 10 минут, P6.3).
    - Триггеры усложняют отладку и тестирование по сравнению с кодом в Rates Service.
    - Две модели доступа (API и CSV) усложняют поддержку.
- **Ограничения**:
    - Партнёрский кол-центр ограничен SFTP и CSV, исключая API.
    - Минимальная доработка АБС ограничивает формат данных.
    - Вызов SFTP из триггера может потребовать внешних утилит (например, через хранимую процедуру).
- **Риски**:
    - Триггеры могут замедлить транзакции в БД при высокой нагрузке (P6.5).
    - Сбои SFTP-сервера могут задержать доступ к ставкам.
    - Ошибки парсинга CSV в партнёрской системе из-за несогласованного формата.
    - Неправильная настройка SFTP (SSH-ключи) рискует утечкой данных (+R6.1).